{% extends "main_layout.html" %}
{% block body %}
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="//d3js.org/d3-queue.v2.min.js"></script>
<style>
svg {
  position:absolute;
  width:100%;
  height:100%;
  fill:#bfb;
}
#states {
  fill:#a9a9a9;
}
.territory {
  fill:#c3c3c3;
}
.bubble-1 {
  fill:#CAEBF2;
  fill-opacity:.6;
}
.bubble-2 {
  fill:#FF3B3F;
  fill-opacity:.6;
}
path {
  stroke:#EFEFEF;
  stroke-linejoin:round;
  stroke-linecap:round;
}
</style>
<svg>
  <g id="states" class="center"></g>
</svg>
<h4 class="center">the United States in <span class="year">{{year}}</span></h4>
<script>
  var selectedYear = "{{year|safe}}";
  var censusYear = Math.round(selectedYear/10)*10;
  var svgStates = d3.select("svg #states");
  var width = window.innerWidth,height = window.innerHeight;
  var projection = d3.geo.albersUsa().translate([width/2,height/2]);
  var path = d3.geo.path().projection(projection);
	
	d3_queue.queue()
  .defer(d3.json, "/static/map-data/json/".concat(censusYear).concat(".json"))
  .defer(d3.json, "/candidate_1/".concat(selectedYear))
  .defer(d3.json, "/candidate_2/".concat(selectedYear))
  .await(analyze);

  function analyze(error, usMap, byStateData1, byStateData2) {//wordCounts, 
    if(error) { console.log(error); }
    //console.log(byStateData);
/*    for (var i = 0; i < topologies.length; i++) {
      states[startYear + i * 10] = topojson.feature(topologies[i], topologies[i].objects.stdin);
    }*/
    var us_elements = topojson.feature(usMap, usMap.objects.stdin);

    svgStates.selectAll("path").data(us_elements.features).enter().append("path").attr("d", path)
    .attr("class",function(d) { return isState(d); });
    /*svgStates.selectAll(".us_element").data(us_elements.features).enter()
      .attr("class","us_element")*/

    svgStates.append("g").attr("class", "bubble-1").selectAll("circle")
      .data(us_elements.features).enter().append("circle")
      .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
      .attr("r", function(d) { return getRadius(d, byStateData1); })
      
    svgStates.append("g").attr("class", "bubble-2").selectAll("circle")
      .data(us_elements.features).enter().append("circle")
      .attr("transform", function(d) { return "translate(" + adjustCenter(path.centroid(d), getRadius(d, byStateData2)) + ")"; })
      .attr("r", function(d) { return getRadius(d, byStateData2); })
/*      
      svgStates.selectAll(".us_element").data(states.features).enter()
      .append("text")
      .attr("class","us_element")
      .attr("transform", function(d) { return "translate(" + path.centroid(d) +")"})
      .attr("dy", ".35em")
      .text(function(d) { return wordCounts[d.id]; }); 
      
      
*/
  }
  
  function adjustCenter(c, amt) {
    console.log(c);
    return [c[0],c[1] - amt];
  }
  
  function getRadius(us_element, data_set) {
    var radius = d3.scale.sqrt().domain([0, data_set["max"]]).range([0, 20]);
    if(data_set.hasOwnProperty(us_element.id)) {
      return radius(data_set[us_element.id]);
    } else {
      return 0;
    }
  }
  
  function isState(us_element) {
    var class_name, admit = us_element.properties.admit; 
    if(admit != 0 && admit <= selectedYear) {
      class_name = "state";
    } else {
      class_name = "territory";
    }
    return class_name;
  }
</script>
{% endblock %}